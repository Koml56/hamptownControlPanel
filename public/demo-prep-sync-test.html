<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prep List Multi-Device Sync Demo - WorkVibe</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 700;
        }
        
        .subtitle {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .demo-section {
            padding: 30px;
        }
        
        .demo-instructions {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .status-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .status-card h4 {
            margin: 0 0 10px 0;
            color: #374151;
            font-size: 0.9em;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .status-value {
            font-size: 2em;
            font-weight: bold;
            color: #059669;
        }
        
        .device-id {
            font-size: 0.8em;
            color: #6b7280;
            margin-top: 5px;
        }
        
        .preps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .prep-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .prep-item:hover {
            border-color: #22c55e;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.15);
        }
        
        .prep-item.completed {
            background: #f0fdf4;
            border-color: #22c55e;
        }
        
        .prep-item.highlight {
            animation: highlight 2s ease-in-out;
        }
        
        @keyframes highlight {
            0%, 100% { background-color: white; }
            50% { background-color: #fef3c7; }
        }
        
        .prep-header {
            display: flex;
            items-center: center;
            margin-bottom: 15px;
        }
        
        .prep-checkbox {
            width: 24px;
            height: 24px;
            border: 3px solid #d1d5db;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .prep-checkbox.checked {
            background: #22c55e;
            border-color: #22c55e;
            color: white;
        }
        
        .prep-checkbox::after {
            content: '‚úì';
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .prep-checkbox.checked::after {
            opacity: 1;
        }
        
        .prep-name {
            font-weight: 600;
            color: #374151;
            flex: 1;
        }
        
        .prep-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9em;
        }
        
        .prep-category {
            color: #6b7280;
        }
        
        .prep-time {
            color: #059669;
            font-weight: 500;
        }
        
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(34, 197, 94, 0.95);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 0.9em;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .sync-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }
        
        .sync-info {
            font-size: 0.8em;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üßë‚Äçüç≥ Prep List Sync Demo</h1>
            <p class="subtitle">Multi-Device Real-Time Synchronization Test</p>
            <div class="device-id" id="deviceId">Device ID: Loading...</div>
        </div>
        
        <div class="demo-section">
            <div class="demo-instructions">
                <h3>üß™ How to Test Multi-Device Sync</h3>
                <ol>
                    <li><strong>Open Multiple Tabs:</strong> Open this page in 2+ browser tabs</li>
                    <li><strong>Toggle Prep Items:</strong> Click any prep item checkbox</li>
                    <li><strong>Watch Real-Time Sync:</strong> See changes instantly appear in other tabs</li>
                    <li><strong>Test Conflict Resolution:</strong> Toggle the same item simultaneously in different tabs</li>
                </ol>
                <p><strong>Expected Result:</strong> All tabs should stay perfectly synchronized without conflicts or overrides.</p>
            </div>
            
            <div class="status-grid">
                <div class="status-card">
                    <h4>Completed Preps</h4>
                    <div class="status-value" id="completedCount">0</div>
                    <div class="device-id">Out of <span id="totalCount">0</span> total</div>
                </div>
                <div class="status-card">
                    <h4>Completion Rate</h4>
                    <div class="status-value" id="completionRate">0%</div>
                    <div class="device-id">Active Tabs: <span id="activeTabs">1</span></div>
                </div>
            </div>
            
            <h3>ü•ó Kitchen Prep Tasks</h3>
            <div class="preps-grid" id="prepsGrid">
                <!-- Prep items will be populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <div class="sync-indicator">
        <div class="sync-status">
            <div class="sync-dot"></div>
            <strong>Sync Active</strong>
        </div>
        <div class="sync-info">
            Last sync: <span id="syncTime">Just now</span><br>
            Latency: <span id="syncLatency">< 1ms</span>
        </div>
    </div>

    <script>
        // Sample prep items data
        const prepItems = [
            { id: 1, name: 'Prep vegetables for salads', category: 'Vegetables', time: '45 min' },
            { id: 2, name: 'Marinate chicken breasts', category: 'Proteins', time: '15 min' },
            { id: 3, name: 'Make garlic aioli', category: 'Sauces', time: '10 min' },
            { id: 4, name: 'Slice tomatoes and onions', category: 'Vegetables', time: '20 min' },
            { id: 5, name: 'Prepare sandwich fillings', category: 'Proteins', time: '30 min' },
            { id: 6, name: 'Make herb butter', category: 'Sauces', time: '15 min' },
            { id: 7, name: 'Wash and dry lettuce', category: 'Vegetables', time: '10 min' },
            { id: 8, name: 'Season and grill proteins', category: 'Proteins', time: '60 min' },
            { id: 9, name: 'Prepare soup base', category: 'Soups', time: '40 min' },
            { id: 10, name: 'Slice bread for service', category: 'Baking', time: '15 min' },
            { id: 11, name: 'Make fresh salsa', category: 'Sauces', time: '25 min' },
            { id: 12, name: 'Prep fruit for desserts', category: 'Desserts', time: '20 min' }
        ];

        // Multi-tab sync system for prep lists
        class PrepMultiTabSync {
            constructor() {
                this.deviceId = this.generateDeviceId();
                this.completedPreps = new Set();
                this.activeTabs = new Set();
                this.lastSyncTime = Date.now();
                
                this.init();
            }
            
            generateDeviceId() {
                // Generate unique device ID for each tab (using sessionStorage)
                let deviceId = sessionStorage.getItem('demo_prep_deviceId');
                if (!deviceId) {
                    const timestamp = Date.now().toString(36);
                    const random1 = Math.random().toString(36).substr(2, 6);
                    const random2 = Math.random().toString(36).substr(2, 4);
                    const random3 = Math.random().toString(36).substr(2, 3);
                    deviceId = `prep_device_${timestamp}_${random1}_${random2}_${random3}`;
                    sessionStorage.setItem('demo_prep_deviceId', deviceId);
                }
                return deviceId;
            }
            
            init() {
                // Load existing data
                this.loadData();
                
                // Set up storage listener for real-time sync
                window.addEventListener('storage', (e) => {
                    if (e.key === 'demo_completedPreps') {
                        this.handleRemoteUpdate(e.newValue);
                    } else if (e.key === 'demo_activePrepTabs') {
                        this.updateActiveTabsDisplay();
                    }
                });
                
                // Register this tab as active
                this.registerTab();
                
                // Update UI
                this.updateUI();
                this.updateDeviceInfo();
                
                // Set up heartbeat to maintain active tab list
                setInterval(() => this.heartbeat(), 1000);
                
                // Clean up on page unload
                window.addEventListener('beforeunload', () => this.cleanup());
                
                // Render prep items
                this.renderPrepItems();
            }
            
            loadData() {
                const stored = localStorage.getItem('demo_completedPreps');
                if (stored) {
                    this.completedPreps = new Set(JSON.parse(stored));
                }
            }
            
            saveData() {
                localStorage.setItem('demo_completedPreps', JSON.stringify([...this.completedPreps]));
                this.updateSyncTime();
            }
            
            handleRemoteUpdate(newValue) {
                if (newValue) {
                    const startTime = performance.now();
                    this.completedPreps = new Set(JSON.parse(newValue));
                    this.updateUI();
                    
                    // Show sync latency
                    const latency = (performance.now() - startTime).toFixed(2);
                    document.getElementById('syncLatency').textContent = `${latency}ms`;
                    
                    console.log(`üì° [PREP-SYNC] Remote sync received in ${latency}ms`);
                }
            }
            
            togglePrep(prepId) {
                const startTime = performance.now();
                
                if (this.completedPreps.has(prepId)) {
                    this.completedPreps.delete(prepId);
                    console.log(`‚ùå [PREP-SYNC] Prep ${prepId} unchecked`);
                } else {
                    this.completedPreps.add(prepId);
                    console.log(`‚úÖ [PREP-SYNC] Prep ${prepId} checked`);
                }
                
                // Immediate local update
                this.updateUI();
                
                // Immediate sync to other tabs (no delay!)
                this.saveData();
                
                const syncTime = (performance.now() - startTime).toFixed(2);
                console.log(`üöÄ [PREP-SYNC] Sync completed in ${syncTime}ms`);
                
                // Highlight the synced prep item
                this.highlightPrep(prepId);
            }
            
            highlightPrep(prepId) {
                const prepElement = document.querySelector(`[data-prep-id="${prepId}"]`);
                if (prepElement) {
                    prepElement.classList.add('highlight');
                    setTimeout(() => {
                        prepElement.classList.remove('highlight');
                    }, 2000);
                }
            }
            
            updateUI() {
                const completedCount = this.completedPreps.size;
                const totalCount = prepItems.length;
                const completionRate = Math.round((completedCount / totalCount) * 100);
                
                document.getElementById('completedCount').textContent = completedCount;
                document.getElementById('totalCount').textContent = totalCount;
                document.getElementById('completionRate').textContent = `${completionRate}%`;
                
                // Update prep item checkboxes
                prepItems.forEach(prep => {
                    const checkbox = document.querySelector(`[data-prep-id="${prep.id}"] .prep-checkbox`);
                    const prepItem = document.querySelector(`[data-prep-id="${prep.id}"]`);
                    
                    if (checkbox && prepItem) {
                        const isCompleted = this.completedPreps.has(prep.id);
                        checkbox.classList.toggle('checked', isCompleted);
                        prepItem.classList.toggle('completed', isCompleted);
                    }
                });
            }
            
            updateDeviceInfo() {
                document.getElementById('deviceId').textContent = `Device ID: ${this.deviceId}`;
            }
            
            registerTab() {
                const activeTabs = JSON.parse(localStorage.getItem('demo_activePrepTabs') || '{}');
                activeTabs[this.deviceId] = Date.now();
                localStorage.setItem('demo_activePrepTabs', JSON.stringify(activeTabs));
                this.updateActiveTabsDisplay();
            }
            
            heartbeat() {
                this.registerTab(); // Update timestamp
            }
            
            updateActiveTabsDisplay() {
                const activeTabs = JSON.parse(localStorage.getItem('demo_activePrepTabs') || '{}');
                const now = Date.now();
                const activeCount = Object.values(activeTabs).filter(timestamp => (now - timestamp) < 5000).length;
                document.getElementById('activeTabs').textContent = activeCount;
            }
            
            updateSyncTime() {
                const now = new Date();
                document.getElementById('syncTime').textContent = now.toLocaleTimeString();
            }
            
            cleanup() {
                const activeTabs = JSON.parse(localStorage.getItem('demo_activePrepTabs') || '{}');
                delete activeTabs[this.deviceId];
                localStorage.setItem('demo_activePrepTabs', JSON.stringify(activeTabs));
            }
            
            renderPrepItems() {
                const grid = document.getElementById('prepsGrid');
                grid.innerHTML = prepItems.map(prep => `
                    <div class="prep-item" data-prep-id="${prep.id}" onclick="syncSystem.togglePrep(${prep.id})">
                        <div class="prep-header">
                            <div class="prep-checkbox"></div>
                            <div class="prep-name">${prep.name}</div>
                        </div>
                        <div class="prep-details">
                            <div class="prep-category">üìÇ ${prep.category}</div>
                            <div class="prep-time">‚è±Ô∏è ${prep.time}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Initialize the sync system
        const syncSystem = new PrepMultiTabSync();
        
        // Debug logging
        window.addEventListener('load', () => {
            console.log('üßë‚Äçüç≥ Prep List Multi-Device Sync Demo Initialized');
            console.log('üì± Device ID:', syncSystem.deviceId);
            console.log('üìã Instructions: Open this page in multiple tabs to test prep list synchronization');
        });
    </script>
</body>
</html>